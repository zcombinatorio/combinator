Prerequisites:
  - API running locally: pnpm run api (runs on http://localhost:6770)
  - Environment variables set in .env: RPC_URL, PROTOCOL_PRIVATE_KEY, DB_URL


================================================================================
CRITICAL: MINT AUTHORITY TRANSFER
================================================================================

When transferring mint authority, use the EXACT address from the API field
`mint_vault`. DO NOT derive a vault PDA or any other address.

The API returns the correct target address directly:
  - Field name: `mint_vault`
  - This IS the address to transfer mint authority to
  - This is the Squads vault address

How to get the correct address:
  1. Run: DAO_PDA="..." pnpm tsx scripts/check-dao-db.ts
  2. Look for the `mint_vault` field in the output
  3. Use that EXACT value as NEW_AUTHORITY

Example:
  # After creating DAO, check the database:
  DAO_PDA="PfN2oXruFPqV92rYnVPMMQgi4QwFVxCPkXS99o57ZoC" pnpm tsx scripts/check-dao-db.ts
  # Output shows: "mint_vault": "5KUFpt3tEeDP91nR3LhZi7sUrCBzBobC1WhLzX4qtZwh"

  # Transfer mint authority to that EXACT address:
  TOKEN_MINT="..." NEW_AUTHORITY="5KUFpt3tEeDP91nR3LhZi7sUrCBzBobC1WhLzX4qtZwh" \
    pnpm tsx scripts/transfer-mint-authority.ts

WARNING: Do NOT:
  - Derive a vault PDA from the multisig (the API already returns the correct address)
  - Use any other address than what's in mint_vault
  - Transfer to the treasury_vault (that's for treasury, not mint authority)

================================================================================


E2E Test Plan (Simplified with create-token-with-pool.ts):
  1. Create token + DAMM pool - scripts/create-token-with-pool.ts
     (Default: USDC quote. Use QUOTE_MINT=SOL for SOL quote)
  2. Create parent DAO - scripts/test-dao-parent.ts
  3. Transfer mint authority - scripts/transfer-mint-authority.ts
     (Use mint_vault from API - see CRITICAL section above)
  4. Transfer LP position - scripts/e2e-transfer-lp.ts
  5. Fund admin wallet - scripts/fund-admin-wallet.ts
     (Admin wallet needs SOL for transaction fees - minimum 0.1 SOL, recommended 0.2 SOL)
  6. Verify DAO readiness - scripts/check-dao-db.ts
  7. Check moderator state - scripts/check-moderator.ts
  8. Create proposal - scripts/test-proposal-e2e.ts (or API: POST /dao/proposal)
  9. Wait ~185s - Warmup (60s) + duration (120s) + buffer (5s)
  10. Finalize proposal - API: POST /dao/finalize-proposal
  11. Redeem liquidity - API: POST /dao/redeem-liquidity
  12. Deposit-back - API: POST /dao/deposit-back
  13. Verify LP state - scripts/check-lp-positions.ts


Example Commands (Full E2E with USDC - Recommended):

  # Step 1: Create token + DAMM pool with USDC (default)
  # NOTE: Payer must have USDC in their wallet
  TOKEN_NAME="TestDAO" TOKEN_SYMBOL="TDAO" USDC_AMOUNT=10 TOKEN_PERCENT=10 \
    SKIP_METADATA=true pnpm tsx scripts/create-token-with-pool.ts
  # Outputs: TOKEN_MINT, POOL_ADDRESS

  # Step 2: Create parent DAO
  API_URL=http://localhost:6770 PRIVATE_KEY="..." \
    DAO_NAME="TestDAO$(date +%s)" TOKEN_MINT="<from-step-1>" POOL_ADDRESS="<from-step-1>" \
    pnpm tsx scripts/test-dao-parent.ts
  # Outputs: DAO_PDA, MODERATOR_PDA, ADMIN_WALLET

  # Step 3: Get mint_vault from API, then transfer mint authority
  DAO_PDA="<from-step-2>" pnpm tsx scripts/check-dao-db.ts
  # Look for mint_vault in output, then:
  TOKEN_MINT="<from-step-1>" NEW_AUTHORITY="<mint_vault from API>" \
    pnpm tsx scripts/transfer-mint-authority.ts

  # Step 4: Transfer LP to admin wallet
  POOL_ADDRESS="<POOL_ADDRESS from step-1>" ADMIN_WALLET="<from-step-2>" \
    pnpm tsx scripts/e2e-transfer-lp.ts

  # Step 5: Fund admin wallet (needs SOL for transaction fees)
  ADMIN_WALLET="<from-step-2>" SOL_AMOUNT=0.2 \
    pnpm tsx scripts/fund-admin-wallet.ts

  # Step 6-7: Verify DAO and moderator state
  DAO_PDA="<from-step-2>" pnpm tsx scripts/check-dao-db.ts
  MODERATOR_PDA="<from-step-2>" pnpm tsx scripts/check-moderator.ts

  # Step 8: Create proposal (this also waits and finalizes)
  API_URL=http://localhost:6770 DAO_PDA="<from-step-2>" PROPOSAL_DURATION_SECS=120 \
    pnpm tsx scripts/test-proposal-e2e.ts

  # Or do steps 8-12 manually:
  # Create proposal via API
  curl -X POST http://localhost:6770/dao/proposal -H "Content-Type: application/json" \
    -d '{"dao_pda": "...", "title": "Test", "description": "...", "options": ["Yes", "No"], "length_secs": 120, "wallet": "...", "signed_hash": "..."}'

  # Wait 185 seconds (60s warmup + 120s duration + 5s buffer)
  sleep 185

  # Finalize
  curl -X POST http://localhost:6770/dao/finalize-proposal -H "Content-Type: application/json" \
    -d '{"proposal_pda": "..."}'

  # Redeem liquidity
  curl -X POST http://localhost:6770/dao/redeem-liquidity -H "Content-Type: application/json" \
    -d '{"proposal_pda": "..."}'

  # Deposit-back
  curl -X POST http://localhost:6770/dao/deposit-back -H "Content-Type: application/json" \
    -d '{"proposal_pda": "..."}'

  # Step 13: Check LP positions
  POOL_ADDRESS="<from-step-1>" ADMIN_WALLET="<from-step-2>" pnpm tsx scripts/check-lp-positions.ts


Notes:
  - Deposit-back may show "deposit_signature: null" with small test amounts due to
    gas costs exceeding the redeemed liquidity. This is expected in testing.
  - LP position is preserved even if deposit fails - admin wallet retains the position
  - The withdrawal_percentage (default 12%) determines how much liquidity is used per proposal


================================================================================
TWAP CRANKING
================================================================================

The TWAP (Time-Weighted Average Price) oracle needs to be cranked periodically during
a proposal's trading period to record price observations. This is used to determine
the winning outcome when the proposal is finalized.

Endpoint: POST /dao/crank-twap
  - Permissionless (no wallet signature required)
  - Takes a proposal_pda
  - Cranks TWAP for all valid pools on the proposal

Request:
  {
    "proposal_pda": "<proposal-pda>"
  }

Response:
  {
    "proposal_pda": "...",
    "pools_cranked": 2,
    "results": [
      { "pool": "...", "signature": "..." },           // Successfully cranked
      { "pool": "...", "skipped": true, "reason": "..." }  // Skipped (see below)
    ]
  }

Skip reasons:
  - "Warmup period not ended (X seconds remaining)" - TWAP oracle is still warming up
  - "Too soon since last crank (X seconds remaining)" - Minimum 60s between cranks

Timing constraints:
  - Warmup period: First ~half of proposal duration (or max 5 min), no cranking allowed
  - Rate limit: Must wait at least 60 seconds between cranks per pool
  - Cranking before these thresholds wastes gas (tx succeeds but returns cached value)

Test script:
  # Full lifecycle test with TWAP cranking
  API_URL=http://localhost:6770 \
    TEST_WALLET_PRIVATE_KEY="<wallet-private-key>" \
    DAO_PDA="<dao-pda>" \
    PROPOSAL_DURATION_SECS=240 \
    pnpm tsx scripts/test-crank-twap.ts

  # Manual crank via curl
  curl -X POST http://localhost:6770/dao/crank-twap \
    -H "Content-Type: application/json" \
    -d '{"proposal_pda": "..."}'

Integration with proposal lifecycle:
  1. Create proposal (POST /dao/proposal)
  2. Wait for warmup to end (~half of proposal duration)
  3. Crank TWAP every 60+ seconds during trading period (POST /dao/crank-twap)
  4. Wait for proposal to end
  5. Finalize proposal (POST /dao/finalize-proposal)
  6. Redeem liquidity (POST /dao/redeem-liquidity)
  7. Deposit back (POST /dao/deposit-back)

Note: TWAP cranking is optional but recommended for accurate price discovery.
If not cranked, the oracle uses cached/interpolated values.


================================================================================
CHILD DAO CREATION
================================================================================

Child DAOs inherit the parent's liquidity pool and moderator, but have their own:
  - Token mint (governance token for the child DAO)
  - Treasury vault
  - Mint vault
  - Admin wallet

Prerequisites:
  - Parent DAO must exist first
  - A token mint for the child DAO (can be created with scripts/create-token.ts)

Steps to create a child DAO:

  # Step 1: Create a token for the child DAO (if not already existing)
  TOKEN_NAME="ChildToken" TOKEN_SYMBOL="CHILD" SKIP_METADATA=true \
    pnpm tsx scripts/create-token.ts
  # Outputs: TOKEN_MINT

  # Step 2: Create the child DAO
  API_URL=http://localhost:6770 \
    PRIVATE_KEY="<parent-dao-owner-private-key>" \
    CHILD_DAO_NAME="MyChildDAO$(date +%s)" \
    PARENT_PDA="<parent-dao-pda>" \
    TOKEN_MINT="<child-token-mint-from-step-1>" \
    pnpm tsx scripts/test-dao-child.ts
  # Outputs: DAO_PDA, ADMIN_WALLET, TREASURY_VAULT, MINT_VAULT

  # Step 3: Verify child DAO in database
  DAO_PDA="<child-dao-pda>" pnpm tsx scripts/check-dao-db.ts
  # Should show: dao_type: "child", parent_dao_id: <parent-id>

  # Step 4: Transfer mint authority for child token (same process as parent)
  # Get mint_vault from API, then:
  TOKEN_MINT="<child-token-mint>" NEW_AUTHORITY="<mint_vault from API>" \
    pnpm tsx scripts/transfer-mint-authority.ts

Key differences from parent DAO:
  - Child DAOs share the parent's pool_address and moderator_pda
  - Child DAOs have their own token_mint (different from parent)
  - Child DAOs do NOT need LP transfer (they use parent's liquidity)
  - Child DAOs do NOT need separate admin wallet funding (they use parent's admin wallet for LP operations)
  - Proposals on child DAOs use the shared pool for liquidity operations

================================================================================


Legacy E2E Test Plan (with DBC pool migration):
  1. Create DBC pool - scripts/setup-test-token-damm.ts
  2. Buy tokens to trigger migration - Manual purchase of ~0.1 SOL
  3-12. Same as simplified flow above, starting from "Create parent DAO"


================================================================================
DAMM WITH SOL QUOTE (ALTERNATIVE)
================================================================================

To use SOL instead of USDC as the quote token in DAMM pools, add QUOTE_MINT=SOL:

  TOKEN_NAME="TestDAO" TOKEN_SYMBOL="TDAO" QUOTE_MINT=SOL SOL_AMOUNT=0.1 TOKEN_PERCENT=10 \
    SKIP_METADATA=true pnpm tsx scripts/create-token-with-pool.ts

All other steps remain the same as the USDC flow above.


================================================================================
DLMM E2E TEST PLAN (TOKEN/USDC POOLS)
================================================================================

DLMM (Dynamic Liquidity Market Maker) pools use concentrated liquidity with
discrete price bins. The DAO endpoints support both DAMM and DLMM pools - the
pool type is auto-detected from the pool address.

NOTE: Both DAMM and DLMM support USDC (default) and SOL as quote tokens.

Key differences from DAMM:
  - DLMM uses concentrated liquidity with price bins (binStep parameter)
  - Positions are account-based, not NFT-based
  - LP "transfer" requires withdrawing and re-depositing liquidity
  - Multiple transactions may be needed for large operations
  - Supports Token-2022 base tokens

DLMM with SOL quote:
  TOKEN_NAME="TestDAODLMM" TOKEN_SYMBOL="TDLMM" QUOTE_MINT=SOL SOL_AMOUNT=0.1 TOKEN_PERCENT=10 \
    BIN_STEP=25 SKIP_METADATA=true pnpm tsx scripts/create-token-with-dlmm-pool.ts

Prerequisites (DLMM):
  - Payer wallet must have USDC or SOL for pool liquidity (default: 10 USDC or 0.1 SOL)
  - Payer wallet must have SOL for transaction fees (~0.1 SOL)

E2E Test Plan (DLMM):
  1. Create token + DLMM pool - scripts/create-token-with-dlmm-pool.ts
  2. Create parent DAO - scripts/test-dao-parent.ts (same as DAMM)
  3. Transfer mint authority - scripts/transfer-mint-authority.ts (same as DAMM)
  4. Transfer LP liquidity - scripts/e2e-transfer-dlmm-lp.ts
  5. Fund admin wallet - scripts/fund-admin-wallet.ts (same as DAMM)
  6. Verify DAO readiness - scripts/check-dao-db.ts (same as DAMM)
  7. Check DLMM positions - scripts/check-dlmm-lp-positions.ts
  8. Create proposal - scripts/test-proposal-e2e.ts (same as DAMM)
  9. Wait for proposal duration
  10. Finalize proposal - API: POST /dao/finalize-proposal
  11. Redeem liquidity - API: POST /dao/redeem-liquidity
  12. Deposit-back - API: POST /dao/deposit-back
  13. Verify LP state - scripts/check-dlmm-lp-positions.ts


Example Commands (DLMM E2E):

  # Step 1: Create token + DLMM pool (TOKEN/USDC)
  # NOTE: Payer must have USDC in their wallet
  TOKEN_NAME="TestDAODLMM" TOKEN_SYMBOL="TDLMM" USDC_AMOUNT=10 TOKEN_PERCENT=10 \
    BIN_STEP=25 SKIP_METADATA=true pnpm tsx scripts/create-token-with-dlmm-pool.ts
  # Outputs: TOKEN_MINT, POOL_ADDRESS (pool), POSITION

  # Step 2: Create parent DAO (pool type is auto-detected as 'dlmm')
  API_URL=http://localhost:6770 PRIVATE_KEY="..." \
    DAO_NAME="TestDAODLMM$(date +%s)" TOKEN_MINT="<from-step-1>" POOL_ADDRESS="<pool from step-1>" \
    pnpm tsx scripts/test-dao-parent.ts
  # Outputs: DAO_PDA, MODERATOR_PDA, ADMIN_WALLET

  # Step 3: Get mint_vault from API, then transfer mint authority
  DAO_PDA="<from-step-2>" pnpm tsx scripts/check-dao-db.ts
  # Look for mint_vault in output, then:
  TOKEN_MINT="<from-step-1>" NEW_AUTHORITY="<mint_vault from API>" \
    pnpm tsx scripts/transfer-mint-authority.ts

  # Step 4: Transfer LP liquidity to admin wallet (DLMM version)
  # NOTE: Unlike DAMM, DLMM positions can't be directly transferred.
  # This script withdraws liquidity and transfers tokens + USDC to admin.
  POOL_ADDRESS="<pool from step-1>" ADMIN_WALLET="<from-step-2>" \
    pnpm tsx scripts/e2e-transfer-dlmm-lp.ts

  # Step 5: Fund admin wallet (needs SOL for transaction fees)
  ADMIN_WALLET="<from-step-2>" SOL_AMOUNT=0.3 \
    pnpm tsx scripts/fund-admin-wallet.ts
  # NOTE: DLMM may need more SOL due to position creation costs

  # Step 6-7: Verify DAO and check DLMM positions
  DAO_PDA="<from-step-2>" pnpm tsx scripts/check-dao-db.ts
  POOL_ADDRESS="<pool from step-1>" ADMIN_WALLET="<from-step-2>" \
    pnpm tsx scripts/check-dlmm-lp-positions.ts

  # Step 8: Create proposal (this also waits and finalizes)
  API_URL=http://localhost:6770 DAO_PDA="<from-step-2>" PROPOSAL_DURATION_SECS=120 \
    pnpm tsx scripts/test-proposal-e2e.ts

  # Or do steps 8-12 manually (same as DAMM flow)

  # Step 13: Check DLMM LP positions after deposit-back
  POOL_ADDRESS="<pool from step-1>" ADMIN_WALLET="<from-step-2>" \
    pnpm tsx scripts/check-dlmm-lp-positions.ts


DLMM-Specific Notes:
  - BIN_STEP controls price granularity: lower = more precise, higher = wider range
    - 1 = 0.01% per bin (very precise, good for stablecoins)
    - 25 = 0.25% per bin (default, good for most tokens)
    - 100 = 1% per bin (wide range, less capital efficient)
    - Max: 400 = 4% per bin
  - The admin wallet will create positions during the first proposal if none exist
  - DLMM withdrawal/deposit may use multiple transactions for large amounts
  - Position bin range affects how much price movement the position can handle
  - Quote token is USDC (EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v)


Token-2022 Support:
  - DLMM flow supports Token-2022 (Token Extensions) as the base token
  - To create a Token-2022 base token, add USE_TOKEN_2022=true to create-token-with-dlmm-pool.ts
  - Example:
    USE_TOKEN_2022=true TOKEN_NAME="TestDAO22" TOKEN_SYMBOL="TD22" USDC_AMOUNT=10 \
      pnpm tsx scripts/create-token-with-dlmm-pool.ts
  - Token program is auto-detected in all downstream scripts
  - Token-2022 tokens can use extensions like transfer fees, but basic tokens work out of the box
