---
title: "Confirm Presale Claim"
description: "POST /presale/:tokenAddress/claims/confirm - Submit signed transaction to complete presale token claim"
---

## Overview

Receives a user-signed claim transaction from `/claims/prepare`, re-validates eligibility, adds the escrow's signature, and submits the complete transaction to the Solana blockchain to finalize the presale token claim. This endpoint also records the claim in the database for vesting tracking.

<CodeGroup>

```bash curl
curl -X POST https://api.zcombinator.io/presale/EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v/claims/confirm \
  -H "Content-Type: application/json" \
  -d '{
    "signedTransaction": "4MzR7dxJNJRVP1Q6k7Y3j8X...",
    "timestamp": 1642248400000
  }'
```

```javascript fetch
const response = await fetch(
  'https://api.zcombinator.io/presale/EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v/claims/confirm',
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      signedTransaction: signedTransactionBase58,
      timestamp: 1642248400000
    })
  }
);

const result = await response.json();
```

```python requests
import requests

data = {
    "signedTransaction": signed_transaction_base58,
    "timestamp": 1642248400000
}

response = requests.post(
    'https://api.zcombinator.io/presale/EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v/claims/confirm',
    json=data,
    headers={'Content-Type': 'application/json'}
)

result = response.json()
```

</CodeGroup>

## URL Parameters

<ParamField path="tokenAddress" type="string" required>
  The Solana token mint address of the presale
</ParamField>

## Request Parameters

<ParamField body="signedTransaction" type="string" required>
  Base58 encoded transaction signed by the user's wallet
</ParamField>

<ParamField body="timestamp" type="number" required>
  Unix timestamp (milliseconds) returned from `/claims/prepare`
</ParamField>

## Response

<ResponseField name="success" type="boolean">
  Indicates if the operation was successful
</ResponseField>

<ResponseField name="signature" type="string">
  The Solana transaction signature/hash
</ResponseField>

<ResponseField name="claimedAmount" type="string">
  The amount of tokens successfully claimed (in smallest units)
</ResponseField>

<ResponseField name="decimals" type="number">
  Number of decimal places for the token
</ResponseField>

### Success Response

```json
{
  "success": true,
  "signature": "5VfYiDvQMBSWxKJLa9NLPQ1x3...",
  "claimedAmount": "250000000000",
  "decimals": 9
}
```

## Error Responses

<AccordionGroup>
  <Accordion title="400 - Missing Parameters">
    ```json
    {
      "error": "Missing required parameters"
    }
    ```
  </Accordion>

  <Accordion title="400 - Invalid Token Address">
    ```json
    {
      "error": "Invalid token address format"
    }
    ```
  </Accordion>

  <Accordion title="400 - Invalid Timestamp">
    ```json
    {
      "error": "Invalid timestamp"
    }
    ```

    Timestamp must be a positive number not in the future.
  </Accordion>

  <Accordion title="400 - Claim Not Found">
    ```json
    {
      "error": "Claim transaction not found or expired"
    }
    ```

    This occurs when:
    - Invalid timestamp
    - Transaction expired (>5 minutes)
    - Transaction already processed
  </Accordion>

  <Accordion title="400 - Claim Expired">
    ```json
    {
      "error": "Claim transaction expired"
    }
    ```

    The transaction was prepared more than 5 minutes ago.
  </Accordion>

  <Accordion title="400 - Not Yet Unlocked">
    ```json
    {
      "error": "Cannot claim yet. Next unlock in 45 minutes at 2024-01-16T10:30:00.000Z",
      "nextUnlockTime": "2024-01-16T10:30:00.000Z",
      "minutesRemaining": 45
    }
    ```

    Vesting schedule changed between prepare and confirm steps.
  </Accordion>

  <Accordion title="400 - Amount Changed">
    ```json
    {
      "error": "Claim amount is no longer valid. Please prepare a new transaction.",
      "currentClaimable": "100000",
      "requestedAmount": "250000"
    }
    ```

    The claimable amount decreased since the transaction was prepared.
  </Accordion>

  <Accordion title="400 - Invalid Blockhash">
    ```json
    {
      "error": "Invalid transaction: missing blockhash"
    }
    ```

    Or:

    ```json
    {
      "error": "Invalid transaction: blockhash is expired. Please create a new transaction."
    }
    ```

    The transaction's blockhash is missing or no longer valid on-chain.
  </Accordion>

  <Accordion title="400 - Invalid Signature">
    ```json
    {
      "error": "Invalid transaction: must be cryptographically signed by the claiming wallet"
    }
    ```

    The transaction was not properly signed by the user's wallet.
  </Accordion>

  <Accordion title="400 - Invalid Transaction Structure">
    ```json
    {
      "error": "Invalid transaction: no transfer instruction found"
    }
    ```

    Or:

    ```json
    {
      "error": "Invalid transaction: only one transfer allowed"
    }
    ```

    Or:

    ```json
    {
      "error": "Invalid transaction: transfer details do not match claim"
    }
    ```

    Or:

    ```json
    {
      "error": "Invalid transaction: contains unexpected instructions"
    }
    ```

    The transaction structure was modified or is invalid.
  </Accordion>

  <Accordion title="500 - Server Error">
    ```json
    {
      "error": "Failed to confirm claim"
    }
    ```

    Transaction submission to Solana network failed.
  </Accordion>
</AccordionGroup>

## Process Flow

This endpoint performs comprehensive security validations:

<Steps>
<Step title="Validate Parameters">
Ensures token address, signed transaction, and timestamp are provided
</Step>

<Step title="Acquire Lock">
Acquires presale-specific lock to prevent concurrent processing
</Step>

<Step title="Retrieve Transaction Data">
Fetches stored transaction details using the timestamp
</Step>

<Step title="Verify Expiration">
Confirms transaction is within 5-minute validity window
</Step>

<Step title="Re-validate Vesting">
Critical security check: re-calculates vesting eligibility to prevent race conditions
</Step>

<Step title="Enforce Unlock Time">
Ensures tokens are still unlocked at confirmation time
</Step>

<Step title="Verify Claim Amount">
Confirms the requested amount is still valid
</Step>

<Step title="Deserialize Transaction">
Converts Base58 signed transaction to Solana Transaction object
</Step>

<Step title="Validate Blockhash">
Checks that the transaction has a valid, non-expired blockhash
</Step>

<Step title="Verify User Signature">
Cryptographically validates the user's signature using nacl
</Step>

<Step title="Validate Transaction Structure">
Ensures transaction only contains expected instructions:
- Optional: Compute Budget instructions
- Optional: Associated Token Account creation
- Required: Single transfer from escrow to user
- No unexpected programs or instructions
</Step>

<Step title="Validate Transfer Details">
Confirms transfer is:
- From escrow token account to user token account
- Signed by escrow as authority
- For the correct amount
</Step>

<Step title="Add Escrow Signature">
Signs transaction with decrypted escrow keypair
</Step>

<Step title="Submit to Blockchain">
Sends fully signed transaction to Solana network
</Step>

<Step title="Wait for Confirmation">
Polls transaction status until confirmed (up to 60 seconds)
</Step>

<Step title="Record Claim">
Stores claim record in database with signature, block time, and slot
</Step>

<Step title="Cleanup">
Removes temporary transaction data from storage
</Step>
</Steps>

## Security Re-validation

<Warning>
**Critical Security Checks**: The API re-validates all eligibility requirements at confirmation time to prevent:
- Claiming before unlock time (race condition)
- Claiming more than vested (if vesting changed)
- Double claiming (transaction replay)
- Modified transactions (signature validation)
</Warning>

### Multi-Layer Validation
1. **Vesting Schedule**: Re-calculated in real-time
2. **Cryptographic Signature**: nacl signature verification
3. **Transaction Structure**: Instruction-level validation
4. **Transfer Details**: Amount, accounts, and authority validation
5. **Blockhash**: Prevents replay attacks

## Transaction Validation

The API performs deep transaction inspection:

### Allowed Instructions
- ✅ **Compute Budget Program**: For setting compute units
- ✅ **Associated Token Program**: For creating token accounts
- ✅ **Token Program (Transfer)**: Single transfer from escrow to user
- ✅ **Lighthouse Program**: For transaction optimization

### Blocked Instructions
- ❌ Any other programs
- ❌ Multiple transfers
- ❌ Transfers to wrong accounts
- ❌ Transfers with wrong amounts

## Rate Limiting

This endpoint is subject to rate limiting:
- **30 requests per IP** per 1-minute window
- Returns HTTP 429 when limit exceeded

## Transaction Lifecycle

The claim transaction follows this lifecycle:

1. **Preparation**: `/claims/prepare` creates unsigned transaction
2. **Storage**: Transaction data stored for 5 minutes
3. **Signing**: User signs transaction with their wallet
4. **Confirmation**: This endpoint validates, signs, and submits
5. **Recording**: Claim recorded in database
6. **Cleanup**: Transaction data removed
7. **Finality**: Tokens permanently transferred to user

## Database Recording

<Info>
**Claim Tracking**: Each successful claim is recorded with:
- Transaction signature
- Claimed amount
- Block time and slot
- Used for vesting calculations in future claims
</Info>

## After Successful Claim

Once tokens are successfully claimed:

1. **Verify Balance**: Check user's token account balance on-chain
2. **Update UI**: Refresh vesting info from [`/claims/:wallet`](/api-reference/presale/claims-info)
3. **Transaction Proof**: Use `signature` to view on Solana explorers
4. **Next Claim**: User can claim again when more tokens vest

## Transaction Signature

The returned `signature` can be used to:
- View on Solana Explorer: `https://explorer.solana.com/tx/${signature}`
- Verify claim on-chain
- Provide proof of claim to users
- Track transaction finality

## Integration Example

```javascript
import { Transaction } from '@solana/web3.js';
import bs58 from 'bs58';

// After user signs the transaction from /prepare
const signedTx = await wallet.signTransaction(transaction);

// Submit to confirm endpoint
const response = await fetch(
  `/presale/${tokenAddress}/claims/confirm`,
  {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      signedTransaction: bs58.encode(signedTx.serialize()),
      timestamp: prepareResult.timestamp
    })
  }
);

const result = await response.json();

if (result.success) {
  console.log(`Claimed ${result.claimedAmount} tokens!`);
  console.log(`Transaction: ${result.signature}`);

  // Show link to explorer
  const explorerUrl = `https://explorer.solana.com/tx/${result.signature}`;
  console.log(`View on explorer: ${explorerUrl}`);
}
```

## Error Handling

<Tip>
**Retry Logic**: If the transaction fails due to network issues, the user may need to call `/prepare` again for a fresh transaction with a new blockhash.
</Tip>

<Tip>
**Expiry Handling**: If users take too long to sign, catch the expiry error and automatically call `/prepare` again.
</Tip>

## Next Steps

After a successful claim:

1. **Refresh Vesting Info**: Call [`/presale/:tokenAddress/claims/:wallet`](/api-reference/presale/claims-info) to update UI
2. **Check Balance**: Verify tokens arrived in user's wallet
3. **Schedule Next Claim**: If more tokens remain, set up next claim at next unlock time
